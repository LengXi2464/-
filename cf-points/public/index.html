<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç§¯åˆ†å‰å°</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
  <style>
    :root {
      --neon: #8b5cf6;
      --neon2: #22d3ee;
    }
    body {
      background: linear-gradient(120deg, rgba(139,92,246,.15), rgba(34,211,238,.15)) fixed;
      position: relative;
      overflow-x: hidden;
      min-height: 100dvh;
    }
    .bg-anim {
      position: fixed; inset: -20vh -20vw auto -20vw; height: 80vh; z-index: -1;
      background: radial-gradient(60% 60% at 30% 20%, rgba(139,92,246,.35), transparent 60%),
                  radial-gradient(50% 50% at 80% 30%, rgba(34,211,238,.25), transparent 60%),
                  radial-gradient(50% 50% at 40% 80%, rgba(236,72,153,.2), transparent 60%);
      filter: blur(40px); animation: float 12s ease-in-out infinite alternate;
    }
    @keyframes float { from { transform: translateY(-20px) scale(1); } to { transform: translateY(20px) scale(1.05); } }
    .stack { display: grid; gap: 1rem; }
    .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .muted { color: var(--muted-color); font-size: .9rem; }
    .nowrap { white-space: nowrap; }
    .center { display:flex; align-items:center; gap:.5rem; }
    article { background: rgba(255,255,255,.6); backdrop-filter: saturate(150%) blur(8px); border: 1px solid rgba(255,255,255,.35); border-radius: 14px; padding: 1rem; }
    [data-theme="dark"] article { background: rgba(20,20,30,.45); border-color: rgba(255,255,255,.08); }
    button.contrast, button.secondary, button {
      position: relative; isolation: isolate;
    }
    button:hover { box-shadow: 0 0 0 2px color-mix(in oklab, var(--neon) 50%, transparent), 0 10px 24px -8px color-mix(in oklab, var(--neon2) 35%, transparent); }

    /* Navbar & Footer */
    .navbar { position: sticky; top: 0; z-index: 20; background: linear-gradient(180deg, #5b79ff, #6a8bff); color: #fff; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    .navbar .wrap { display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; }
    .navbar .brand { display:flex; align-items:center; gap:.5rem; font-weight:700; }
    .navbar .actions { display:flex; gap:.5rem; align-items:center; }
    .pill { background: rgba(255,255,255,.2); border: 1px solid rgba(255,255,255,.35); color:#fff; border-radius:999px; padding:.4rem .8rem; }
    .pill:hover { background: rgba(255,255,255,.3); }
    .footer { margin-top: 3rem; background:#111827; color:#cbd5e1; padding:1.2rem; box-shadow: 0 -8px 24px rgba(0,0,0,.12) inset; }
    .footer .wrap { display:flex; align-items:center; justify-content:center; gap:.5rem; }
    main.container { padding-top: 1rem; }
    .section-title { display:flex; align-items:center; gap:.6rem; font-size:1.05rem; }
    .badge { background:#10b98122; color:#10b981; border:1px solid #10b98155; padding:.2rem .5rem; border-radius:8px; font-size:.85rem; }
  </style>
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js"></script>
</head>
<body>
  <div class="bg-anim" aria-hidden="true"></div>
  <!-- Top Navbar -->
  <nav class="navbar">
    <div class="wrap container">
      <div class="brand">â­ ç§¯åˆ†ç³»ç»Ÿ</div>
      <div class="actions">
        <a href="#login" class="pill" id="goto-login">ç™»å½•/æ³¨å†Œ</a>
        <a href="/admin.html" class="pill">ç®¡ç†åå°</a>
      </div>
    </div>
  </nav>
  <main class="container">
    <header class="stack">
      <h1 style="margin:.25rem 0">æ¬¢è¿æ¥åˆ°ä½ çš„ç§¯åˆ†ç©ºé—´</h1>
      <article class="stack">
        <div class="grid">
          <label>
            ç”¨æˆ·å
            <input id="username" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </label>
          <div class="center">
            <button id="btn-init" class="contrast">è¿›å…¥ / åŒæ­¥</button>
            <span class="muted">å½“å‰ç§¯åˆ†ï¼š<b id="balance">0</b></span>
          </div>
        </div>
      </article>
    </header>

    <section class="stack">
      <article class="stack">
        <div class="section-title"><span>ğŸŸ¢</span><strong>æ·»åŠ äº‹ä»¶ç§¯åˆ†</strong> <span class="badge">å¯æ­£å¯è´Ÿ</span></div>
        <div class="grid">
          <input id="title" placeholder="äº‹ä»¶æè¿°" />
          <input id="points" type="number" placeholder="åˆ†å€¼ï¼ˆå¯æ­£å¯è´Ÿï¼‰" />
        </div>
        <div>
          <button id="btn-add">æäº¤</button>
        </div>
      </article>

      <article class="stack">
        <div class="section-title"><span>ğŸ</span><strong>å¯å…‘æ¢ç‰©å“</strong></div>
        <div id="rewards" class="stack"></div>
      </article>

      <article class="stack">
        <div class="section-title"><span>ğŸ”„</span><strong>äº‹ä»¶å†å²</strong></div>
        <ul id="events" class="stack"></ul>
      </article>
    </section>
  </main>
  <!-- Footer -->
  <footer class="footer">
    <div class="wrap">
      <span>â­ ç§¯åˆ†ç³»ç»Ÿ Â· è®©æ¯ä¸€ä»½åŠªåŠ›éƒ½è¢«è®°å½•</span>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    let currentUser = '';

    // Particle burst using anime.js
    function burstAt(x, y, color = getComputedStyle(document.documentElement).getPropertyValue('--neon')) {
      const particles = Array.from({ length: 18 }).map(() => {
        const div = document.createElement('div');
        div.style.position = 'fixed';
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.width = div.style.height = Math.random() > .5 ? '4px' : '6px';
        div.style.borderRadius = '50%';
        div.style.pointerEvents = 'none';
        div.style.background = Math.random() > .5 ? 'var(--neon)' : 'var(--neon2)';
        document.body.appendChild(div);
        return div;
      });
      anime.timeline({
        easing: 'easeOutExpo', duration: 900,
        complete: () => particles.forEach(p => p.remove())
      }).add({
        targets: particles,
        translateX: () => anime.random(-120, 120),
        translateY: () => anime.random(-120, 120),
        scale: () => anime.random(8,12)/10,
        opacity: [{ value: 1, duration: 100 }, { value: 0, duration: 500, delay: 300 }]
      });
    }

    async function refresh() {
      if (!currentUser) return;
      const r = await fetch(`/api/overview?username=${encodeURIComponent(currentUser)}`);
      const data = await r.json();
      $("balance").textContent = data.balance ?? 0;
      const ev = data.events || [];
      $("events").innerHTML = ev.map(e => `<li>
        <article class="center" style="justify-content:space-between;">
          <div>
            <span class="muted">#${e.id}</span>
            <span class="muted">[${e.created_at}]</span>
            <strong>${e.title}</strong>
          </div>
          <strong class="nowrap">${e.points > 0 ? '+' : ''}${e.points}</strong>
        </article>
      </li>`).join('');
      const rewards = data.rewards || [];
      $("rewards").innerHTML = rewards.length ? rewards.map(rw => `
        <article class="grid" style="align-items:center; grid-template-columns: 1fr auto auto auto;">
          <div>
            <strong>${rw.name}</strong>
            <div class="muted">${rw.description || ''}</div>
          </div>
          <div class="nowrap">æ¶ˆè€—ï¼š<b>${rw.cost_points}</b></div>
          <div class="nowrap">${rw.stock === null ? '' : 'åº“å­˜ï¼š' + rw.stock}</div>
          <div><button class="secondary" onclick="redeem(${rw.id})">å…‘æ¢</button></div>
        </article>
      `).join('') : '<div class="muted">æš‚æ— å¥–åŠ±</div>';
    }

    // scroll to login input
    $("goto-login").onclick = (e) => { e.preventDefault(); const el = $("username"); el.scrollIntoView({ behavior:'smooth', block:'center' }); setTimeout(()=>el.focus(), 400); };

    $("btn-init").onclick = async (e) => {
      currentUser = $("username").value.trim();
      if (!currentUser) return alert('è¯·è¾“å…¥ç”¨æˆ·å');
      const r = await fetch('/api/user/init', { method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify({ username: currentUser }) });
      const data = await r.json();
      $("balance").textContent = data.balance ?? 0;
      $("events").innerHTML = (data.events||[]).map(e => `<li>
        <article class="center" style="justify-content:space-between;">
          <div>
            <span class="muted">#${e.id}</span>
            <span class="muted">[${e.created_at}]</span>
            <strong>${e.title}</strong>
          </div>
          <strong class="nowrap">${e.points > 0 ? '+' : ''}${e.points}</strong>
        </article>
      </li>`).join('');
      const rewards = data.rewards || [];
      $("rewards").innerHTML = rewards.length ? rewards.map(rw => `
        <article class="grid" style="align-items:center; grid-template-columns: 1fr auto auto auto;">
          <div>
            <strong>${rw.name}</strong>
            <div class="muted">${rw.description || ''}</div>
          </div>
          <div class="nowrap">æ¶ˆè€—ï¼š<b>${rw.cost_points}</b></div>
          <div class="nowrap">${rw.stock === null ? '' : 'åº“å­˜ï¼š' + rw.stock}</div>
          <div><button class="secondary" onclick="redeem(${rw.id})">å…‘æ¢</button></div>
        </article>
      `).join('') : '<div class="muted">æš‚æ— å¥–åŠ±</div>';
      const rect = e.target.getBoundingClientRect(); burstAt(rect.left + rect.width/2, rect.top + rect.height/2);
    };

    $("btn-add").onclick = async (e) => {
      if (!currentUser) return alert('è¯·å…ˆè¿›å…¥/åŒæ­¥');
      const title = $("title").value.trim();
      const points = Number($("points").value);
      if (!title || Number.isNaN(points)) return alert('è¯·å¡«å†™äº‹ä»¶å’Œåˆ†å€¼');
      const r = await fetch('/api/events', { method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify({ username: currentUser, title, points }) });
      const data = await r.json();
      if (!data.ok) return alert(JSON.stringify(data));
      await refresh();
      const rect = e.target.getBoundingClientRect(); burstAt(rect.left + rect.width/2, rect.top + rect.height/2);
    };

    window.redeem = async (id) => {
      if (!currentUser) return alert('è¯·å…ˆè¿›å…¥/åŒæ­¥');
      const r = await fetch('/api/redeem', { method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify({ username: currentUser, reward_id: id }) });
      const data = await r.json();
      if (!data.ok) return alert(JSON.stringify(data));
      await refresh();
      // burst at center of screen for emphasis
      burstAt(window.innerWidth/2, 120);
    };
  </script>
</body>
</html>
