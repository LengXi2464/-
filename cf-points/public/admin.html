<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>积分后台</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
  <style>
    :root { --neon: #8b5cf6; --neon2: #22d3ee; }
    body { background: linear-gradient(120deg, rgba(139,92,246,.15), rgba(34,211,238,.15)) fixed; min-height:100dvh; overflow-x:hidden; }
    .bg-anim { position: fixed; inset: -20vh -20vw auto -20vw; height: 80vh; z-index: -1;
      background: radial-gradient(60% 60% at 30% 20%, rgba(139,92,246,.35), transparent 60%),
                  radial-gradient(50% 50% at 80% 30%, rgba(34,211,238,.25), transparent 60%),
                  radial-gradient(50% 50% at 40% 80%, rgba(236,72,153,.2), transparent 60%);
      filter: blur(40px); animation: float 12s ease-in-out infinite alternate; }
    @keyframes float { from { transform: translateY(-20px) } to { transform: translateY(20px) } }
    .stack { display:grid; gap:1rem; }
    .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .muted { color: var(--muted-color); font-size: .9rem; }
    article { background: rgba(255,255,255,.6); backdrop-filter: saturate(150%) blur(8px); border: 1px solid rgba(255,255,255,.35); border-radius: 14px; padding: 1rem; }
    [data-theme="dark"] article { background: rgba(20,20,30,.45); border-color: rgba(255,255,255,.08); }
    button:hover { box-shadow: 0 0 0 2px color-mix(in oklab, var(--neon) 50%, transparent), 0 10px 24px -8px color-mix(in oklab, var(--neon2) 35%, transparent); }

    /* Navbar & Footer to match index */
    .navbar { position: sticky; top: 0; z-index: 20; background: linear-gradient(180deg, #5b79ff, #6a8bff); color: #fff; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    .navbar .wrap { display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; }
    .navbar .brand { display:flex; align-items:center; gap:.5rem; font-weight:700; }
    .navbar .actions { display:flex; gap:.5rem; align-items:center; }
    .pill { background: rgba(255,255,255,.2); border: 1px solid rgba(255,255,255,.35); color:#fff; border-radius:999px; padding:.4rem .8rem; }
    .pill:hover { background: rgba(255,255,255,.3); }
    .footer { margin-top: 3rem; background:#111827; color:#cbd5e1; padding:1.2rem; box-shadow: 0 -8px 24px rgba(0,0,0,.12) inset; }
    .footer .wrap { display:flex; align-items:center; justify-content:center; gap:.5rem; }
  </style>
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js"></script>
</head>
<body>
  <div class="bg-anim" aria-hidden="true"></div>
  <div id="toast" style="position:fixed; right:16px; top:16px; z-index:50; display:grid; gap:.5rem;"></div>
  <!-- Top Navbar -->
  <nav class="navbar">
    <div class="wrap container">
      <div class="brand">⭐ 积分系统</div>
      <div class="actions">
        <a href="/" class="pill">前台</a>
        <span class="pill" aria-current="page">管理后台</span>
        <a href="/admin-login.html" class="pill">登录</a>
        <button id="btn-logout" class="pill" style="border:none; cursor:pointer;">退出</button>
      </div>
    </div>
  </nav>
  <main class="container">
    <header class="stack">
      <h1>积分后台</h1>
      <article>
        <div class="grid" style="align-items:end;">
          <label>
            管理员 Token
            <input id="token" placeholder="x-admin-token" />
          </label>
          <div>
            <button id="btn-refresh" class="secondary">刷新奖励</button>
          </div>
        </div>
      </article>
    </header>

    <section class="stack">
      <article class="stack">
        <h3>创建 / 更新 / 删除 奖励</h3>
        <div class="grid">
          <input id="rw-id" placeholder="ID（更新/删除用）" />
          <input id="rw-name" placeholder="名称" />
          <input id="rw-cost" type="number" placeholder="消耗积分" />
          <input id="rw-stock" type="number" placeholder="库存（留空为无限）" />
          <input id="rw-desc" placeholder="描述" />
          <label class="muted"><input type="checkbox" id="rw-enabled" checked /> 启用</label>
        </div>
        <div class="grid" style="grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));">
          <button onclick="createReward()" class="contrast">创建</button>
          <button onclick="updateReward()">更新</button>
          <button onclick="deleteReward()" class="secondary">删除</button>
        </div>
      </article>

      <article class="stack">
        <h3>奖励列表</h3>
        <div class="grid" style="align-items:end; grid-template-columns: 1fr auto auto auto;">
          <input id="rw-search" placeholder="搜索奖励名称/描述" />
          <div>
            <button id="rw-export" class="secondary">导出CSV</button>
          </div>
          <div class="muted" id="rw-summary"></div>
          <div class="muted" id="rw-pages"></div>
        </div>
        <div id="rewards" class="stack"></div>
      </article>

      <article class="stack">
        <h3>用户列表</h3>
        <div class="grid" style="align-items:end; grid-template-columns: 1fr auto auto auto;">
          <input id="u-search" placeholder="搜索用户名" />
          <div>
            <button id="u-export" class="secondary">导出CSV</button>
          </div>
          <div class="muted" id="u-summary"></div>
          <div class="muted" id="u-pages"></div>
        </div>
        <div id="users" class="stack"></div>
      </article>

      <article class="stack">
        <h3>用户积分调整</h3>
        <div class="grid" style="align-items:end;">
          <input id="u-name" placeholder="用户名" />
          <input id="u-delta" type="number" placeholder="增减分（可负数）" />
          <input id="u-reason" placeholder="原因（可选）" />
          <button onclick="adjust()">提交</button>
        </div>
      </article>
    </section>
  </main>
  <!-- Footer -->
  <footer class="footer">
    <div class="wrap">
      <span>⭐ 积分系统 · 后台管理</span>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const hdr = () => ({ 'content-type':'application/json', 'x-admin-token': $("token").value.trim() });
    // pagination state
    const state = {
      rPage: 1, rSize: 10, rKeyword: '', rTotal: 0,
      uPage: 1, uSize: 10, uKeyword: '', uTotal: 0
    }

    // cute toast
    function notify(text, kind = 'info') {
      const el = document.createElement('div');
      el.textContent = text;
      el.style.padding = '.6rem .9rem';
      el.style.borderRadius = '12px';
      el.style.fontWeight = '600';
      el.style.color = kind === 'error' ? '#fff' : '#064e3b';
      el.style.background = kind === 'error' ? '#ef4444' : '#a7f3d0';
      el.style.boxShadow = '0 10px 20px rgba(0,0,0,.12)';
      $("toast").appendChild(el);
      setTimeout(() => el.remove(), 3600);
    }

    // anime.js particle burst
    function burstAt(x, y) {
      const particles = Array.from({ length: 18 }).map(() => {
        const d = document.createElement('div');
        d.style.position = 'fixed'; d.style.left = x + 'px'; d.style.top = y + 'px';
        d.style.width = d.style.height = Math.random() > .5 ? '4px' : '6px'; d.style.borderRadius='50%';
        d.style.background = Math.random() > .5 ? 'var(--neon)' : 'var(--neon2)'; d.style.pointerEvents='none';
        document.body.appendChild(d); return d;
      });
      anime.timeline({ easing:'easeOutExpo', duration:900, complete:()=>particles.forEach(p=>p.remove()) })
        .add({ targets: particles, translateX:()=>anime.random(-120,120), translateY:()=>anime.random(-120,120), scale:()=>anime.random(8,12)/10, opacity:[{value:1,duration:80},{value:0,duration:520,delay:280}] });
    }

    async function listRewards() {
      const qp = new URLSearchParams({ page: String(state.rPage), size: String(state.rSize), keyword: state.rKeyword });
      const r = await fetch('/api/admin/rewards?' + qp.toString(), { headers: hdr() });
      if (r.status === 401) { $("rewards").innerHTML = '未授权'; notify('未授权，请检查管理员 Token','error'); return; }
      const data = await r.json();
      state.rTotal = data.total || (data.items||[]).length;
      $("rw-summary").textContent = `共 ${state.rTotal} 条`;
      $("rw-pages").innerHTML = pagebar(state.rPage, state.rSize, state.rTotal, (p)=>{ state.rPage=p; listRewards(); });
      $("rewards").innerHTML = (data.items||data.rewards||[]).map(rw => `
        <article class="grid" style="align-items:center; grid-template-columns: 1fr auto auto auto;">
          <div>
            <strong>#${rw.id} ${rw.name}</strong>
            <div class="muted">${rw.description || ''}</div>
          </div>
          <div>消耗：<b>${rw.cost_points}</b></div>
          <div>${rw.stock === null ? '' : '库存：' + rw.stock}</div>
          <div>${rw.enabled ? '启用' : '停用'}</div>
        </article>
      `).join('');
    }

    async function listUsers() {
      const qp = new URLSearchParams({ page: String(state.uPage), size: String(state.uSize), keyword: state.uKeyword });
      const r = await fetch('/api/admin/users?' + qp.toString(), { headers: hdr() });
      if (r.status === 401) { $("users").innerHTML = '未授权'; return; }
      const data = await r.json();
      state.uTotal = data.total || (data.items||[]).length;
      $("u-summary").textContent = `共 ${state.uTotal} 条`;
      $("u-pages").innerHTML = pagebar(state.uPage, state.uSize, state.uTotal, (p)=>{ state.uPage=p; listUsers(); });
      $("users").innerHTML = (data.items||data.users||[]).map(u => `
        <article class="grid user-row" id="user-${u.id}" style="grid-template-columns: 1fr auto; align-items:center;">
          <div><strong>#${u.id}</strong> ${u.username} <span class="muted">[${u.created_at}]</span></div>
          <div><b>${u.points}</b></div>
        </article>
      `).join('');
    }

    $("btn-refresh").onclick = async (e) => { await listRewards(); await listUsers(); notify('已刷新'); const r = e.target.getBoundingClientRect(); burstAt(r.left + r.width/2, r.top + r.height/2); };

    // persist token
    (function initToken(){
      const saved = localStorage.getItem('admin_token');
      if (saved) { $("token").value = saved; }
      if ($("token").value.trim()) { listRewards(); listUsers(); }
      $("token").addEventListener('input', () => {
        localStorage.setItem('admin_token', $("token").value.trim());
      });
    })();

    // search and export
    $("rw-search").addEventListener('input', () => { state.rKeyword = $("rw-search").value.trim(); state.rPage = 1; listRewards(); });
    $("u-search").addEventListener('input', () => { state.uKeyword = $("u-search").value.trim(); state.uPage = 1; listUsers(); });
    $("rw-export").onclick = async ()=> downloadCSV('/api/admin/export/rewards');
    $("u-export").onclick = async ()=> downloadCSV('/api/admin/export/users');
    $("btn-logout").onclick = async ()=> { await fetch('/api/admin/logout', { method:'POST', headers: hdr() }); notify('已退出'); };

    window.createReward = async (ev) => {
      const name = $("rw-name").value.trim();
      const cost = Number($("rw-cost").value);
      const stockVal = $("rw-stock").value.trim();
      const stock = stockVal === '' ? null : Number(stockVal);
      const description = $("rw-desc").value.trim();
      const r = await fetch('/api/admin/rewards', { method:'POST', headers: hdr(), body: JSON.stringify({ action:'create', name, cost_points: cost, stock, description }) });
      const d = await r.json();
      if (r.ok && d.ok) { notify('奖励已创建'); } else { notify('创建失败','error'); }
      await listRewards(); await listUsers();
      if (ev?.target) { const b = ev.target.getBoundingClientRect(); burstAt(b.left + b.width/2, b.top + b.height/2); }
    };

    window.updateReward = async (ev) => {
      const id = Number($("rw-id").value);
      const name = $("rw-name").value.trim() || undefined;
      const cost = $("rw-cost").value === '' ? undefined : Number($("rw-cost").value);
      const stockVal = $("rw-stock").value.trim();
      const stock = stockVal === '' ? undefined : Number(stockVal);
      const description = $("rw-desc").value.trim() || undefined;
      const enabled = $("rw-enabled").checked;
      const r = await fetch('/api/admin/rewards', { method:'POST', headers: hdr(), body: JSON.stringify({ action:'update', id, name, cost_points: cost, stock, description, enabled }) });
      const d = await r.json();
      if (r.ok && d.ok) { notify('奖励已更新'); } else { notify('更新失败','error'); }
      await listRewards(); await listUsers();
      if (ev?.target) { const b = ev.target.getBoundingClientRect(); burstAt(b.left + b.width/2, b.top + b.height/2); }
    };

    window.deleteReward = async (ev) => {
      const id = Number($("rw-id").value);
      const r = await fetch('/api/admin/rewards', { method:'POST', headers: hdr(), body: JSON.stringify({ action:'delete', id }) });
      const d = await r.json();
      if (r.ok && d.ok) { notify('奖励已删除'); } else { notify('删除失败','error'); }
      await listRewards(); await listUsers();
      if (ev?.target) { const b = ev.target.getBoundingClientRect(); burstAt(b.left + b.width/2, b.top + b.height/2); }
    };

    window.adjust = async (ev) => {
      const username = $("u-name").value.trim();
      const delta = Number($("u-delta").value);
      const reason = $("u-reason").value.trim();
      const r = await fetch('/api/admin/points', { method:'POST', headers: hdr(), body: JSON.stringify({ username, delta, reason: reason || undefined }) });
      const d = await r.json();
      if (r.ok && d.ok) { notify('积分已调整'); } else { notify('调整失败','error'); }
      await listRewards(); await listUsers();
      // highlight the affected user row
      setTimeout(() => {
        const el = document.querySelector(`[id^="user-"]`);
        const target = Array.from(document.querySelectorAll('.user-row')).find(x=> x.textContent.includes(username));
        if (target) {
          target.animate([
            { transform:'scale(1)', boxShadow:'none' },
            { transform:'scale(1.02)', boxShadow:'0 0 0 3px rgba(34,211,238,.35)' },
            { transform:'scale(1)', boxShadow:'none' }
          ], { duration: 900, easing: 'ease-out' });
        }
      }, 100);
      if (ev?.target) { const b = ev.target.getBoundingClientRect(); burstAt(b.left + b.width/2, b.top + b.height/2); }
    };

    function pagebar(page, size, total, onGo){
      const pages = Math.max(1, Math.ceil(total / size));
      const prev = `<button class="secondary" ${page<=1?'disabled':''} data-go="${page-1}">上一页</button>`;
      const next = `<button class="secondary" ${page>=pages?'disabled':''} data-go="${page+1}">下一页</button>`;
      const info = `<span class="muted">第 ${page}/${pages} 页</span>`;
      const html = `${prev} ${info} ${next}`;
      const div = document.createElement('div');
      div.innerHTML = html;
      div.querySelectorAll('button[data-go]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ const p = Number(btn.getAttribute('data-go')); if(p>=1 && p<=pages) onGo(p); });
      });
      return div.innerHTML;
    }

    async function downloadCSV(url){
      const r = await fetch(url, { headers: hdr() });
      if(!r.ok){ notify('导出失败','error'); return; }
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = url.split('/').pop() + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      notify('导出开始');
    }
  </script>
</body>
</html>
